<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lesson 5 ‚Äî Error Handling & Auto-Reconnect</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap"
    rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #ffffff;
      --card: #f8fafc;
      --card2: #f1f5f9;
      --border: #e2e8f0;
      --text: #0f172a;
      --muted: #64748b;
      --dim: #475569;
      --green: #16a34a;
      --blue: #0284c7;
      --purple: #7c3aed;
      --yellow: #ca8a04;
      --red: #dc2626;
      --orange: #ea580c;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .hero {
      text-align: center;
      padding: 56px 24px 40px;
      background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(248, 113, 113, .07), transparent);
      border-bottom: 1px solid var(--border);
    }

    .hero-tag {
      display: inline-block;
      background: rgba(248, 113, 113, .1);
      color: var(--red);
      border: 1px solid rgba(248, 113, 113, .25);
      border-radius: 99px;
      padding: 4px 14px;
      font-size: .75rem;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 18px;
    }

    .hero h1 {
      font-size: clamp(1.8rem, 5vw, 3rem);
      font-weight: 800;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #e2e8f0, #94a3b8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero p {
      font-size: 1rem;
      color: var(--dim);
      max-width: 580px;
      margin: 0 auto;
    }

    .page {
      max-width: 880px;
      margin: 0 auto;
      padding: 44px 24px;
      display: flex;
      flex-direction: column;
      gap: 48px;
    }

    /* SECTION HEADER */
    .sec-label {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .sec-num {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .8rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .sec-num.c-red {
      background: rgba(248, 113, 113, .15);
      color: var(--red);
    }

    .sec-num.c-yellow {
      background: rgba(251, 191, 36, .15);
      color: var(--yellow);
    }

    .sec-num.c-green {
      background: rgba(34, 197, 94, .15);
      color: var(--green);
    }

    .sec-num.c-blue {
      background: rgba(56, 189, 248, .15);
      color: var(--blue);
    }

    .sec-title {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .sec-sub {
      font-size: .84rem;
      color: var(--muted);
      margin-top: 2px;
    }

    /* colour text helpers */
    .c-red {
      color: var(--red);
    }

    .c-green {
      color: var(--green);
    }

    .c-yellow {
      color: var(--yellow);
    }

    strong.c-red {
      color: var(--red);
    }

    strong.c-green {
      color: var(--green);
    }

    strong.c-yellow {
      color: var(--yellow);
    }

    /* code helper */
    code.mono {
      font-family: monospace;
    }

    /* spacing helpers */
    .mt-12 {
      margin-top: 12px;
    }

    .mt-10 {
      margin-top: 10px;
    }

    .mt-14 {
      margin-top: 14px;
    }

    .mb-12 {
      margin-bottom: 12px;
    }

    .mb-14 {
      margin-bottom: 14px;
    }

    /* small note text */
    .note-sm {
      font-size: .82rem;
      color: var(--dim);
    }

    .note-muted {
      font-size: .82rem;
      color: var(--muted);
    }

    /* box with top margin */
    .box.mt {
      margin-top: 16px;
    }

    /* box-head blue */
    .box-head.c-blue {
      color: var(--blue);
    }

    /* BOX */
    .box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }

    .box-head {
      padding: 13px 18px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      font-size: .9rem;
    }

    .box-head.c-red {
      color: var(--red);
    }

    .box-head.c-yellow {
      color: var(--yellow);
    }

    .box-head.c-green {
      color: var(--green);
    }

    .box-head.c-orange {
      color: var(--orange);
    }

    .box-body {
      padding: 16px 18px;
    }

    .box-body p {
      font-size: .87rem;
      color: var(--dim);
      line-height: 1.7;
    }

    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media(max-width:680px) {
      .two-col {
        grid-template-columns: 1fr;
      }
    }

    /* CLOSE CODE TABLE */
    .close-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .82rem;
    }

    .close-table th {
      padding: 9px 14px;
      background: var(--card2);
      color: var(--dim);
      font-weight: 600;
      font-size: .73rem;
      text-transform: uppercase;
      letter-spacing: .3px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    .close-table td {
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      color: var(--dim);
      vertical-align: top;
    }

    .close-table td:first-child {
      font-family: 'Fira Code', monospace;
      color: var(--yellow);
      font-size: .78rem;
    }

    .close-table td:nth-child(2) {
      color: var(--text);
      font-weight: 600;
      font-size: .78rem;
    }

    .close-table tr:last-child td {
      border-bottom: none;
    }

    /* CODE */
    .code {
      font-family: 'Fira Code', monospace;
      font-size: .77rem;
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
      color: #334155;
      overflow-x: auto;
      line-height: 1.9;
    }

    .kw {
      color: #0284c7;
    }

    .fn {
      color: #16a34a;
    }

    .str {
      color: #dc2626;
    }

    .cm {
      color: #475569;
      font-style: italic;
    }

    .num {
      color: #dc2626;
    }

    /* BACKOFF VISUALIZER */
    .backoff-vis {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      padding: 20px;
      background: var(--card3);
      border-radius: 10px;
      height: 130px;
    }

    .backoff-bar-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      flex: 1;
    }

    .backoff-bar {
      width: 100%;
      border-radius: 4px 4px 0 0;
      transition: height .5s cubic-bezier(.4, 0, .2, 1), background .5s;
    }

    .backoff-label {
      font-size: .66rem;
      color: var(--muted);
      font-weight: 600;
    }

    .backoff-sec {
      font-size: .7rem;
      color: var(--dim);
      font-family: 'Fira Code', monospace;
    }

    /* LIVE DEMO */
    .demo-shell {
      background: var(--card);
      border: 1px solid rgba(56, 189, 248, .2);
      border-radius: 16px;
      overflow: hidden;
    }

    .demo-topbar {
      padding: 12px 18px;
      background: var(--card2);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
      background: var(--muted);
      transition: background .3s;
    }

    .dot.open {
      background: var(--green);
      animation: pulse 2s infinite;
    }

    .dot.connecting {
      background: var(--yellow);
      animation: pulse .8s infinite;
    }

    .dot.error {
      background: var(--red);
    }

    @keyframes pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 currentColor;
      }

      50% {
        box-shadow: 0 0 0 4px transparent;
      }
    }

    .status-text {
      font-size: .82rem;
      color: var(--dim);
      flex: 1;
    }

    .retry-badge {
      font-size: .72rem;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 99px;
      background: rgba(251, 191, 36, .15);
      color: var(--yellow);
      display: none;
    }

    .retry-badge.show {
      display: block;
    }

    .demo-log {
      height: 180px;
      overflow-y: auto;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-family: 'Fira Code', monospace;
      font-size: .73rem;
      background: var(--card3);
    }

    .lg {
      display: flex;
      gap: 8px;
    }

    .lg-t {
      color: var(--muted);
      flex-shrink: 0;
    }

    .lg.sys .lg-m {
      color: var(--dim);
    }

    .lg.ok .lg-m {
      color: var(--green);
    }

    .lg.err .lg-m {
      color: var(--red);
    }

    .lg.warn .lg-m {
      color: var(--yellow);
    }

    .lg.recv .lg-m {
      color: var(--blue);
    }

    .demo-controls {
      padding: 14px 18px;
      background: var(--card2);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-family: 'Inter', sans-serif;
      font-size: .82rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .2s, transform .1s;
    }

    .btn:hover:not(:disabled) {
      opacity: .85;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: .3;
      cursor: not-allowed;
    }

    .btn-red {
      background: var(--red);
      color: #1a0000;
    }

    .btn-green {
      background: var(--green);
      color: #052e16;
    }

    .btn-ghost {
      background: var(--card);
      color: var(--dim);
      border: 1px solid var(--border);
    }

    .btn-blue {
      background: var(--blue);
      color: #082f49;
    }

    .countdown-wrap {
      margin-left: auto;
      font-size: .8rem;
      color: var(--muted);
    }

    .countdown-num {
      color: var(--yellow);
      font-weight: 700;
      font-family: 'Fira Code', monospace;
    }

    /* HIGHLIGHT BOX */
    .hl-box {
      border-radius: 10px;
      padding: 14px 16px;
      border-left: 3px solid;
      font-size: .85rem;
      color: var(--dim);
      line-height: 1.7;
      margin-top: 14px;
    }

    .hl-box.green {
      border-color: var(--green);
      background: rgba(34, 197, 94, .05);
    }

    .hl-box.red {
      border-color: var(--red);
      background: rgba(248, 113, 113, .05);
    }

    .hl-box.yellow {
      border-color: var(--yellow);
      background: rgba(251, 191, 36, .05);
    }

    /* GOLDEN RULE */
    .golden {
      background: rgba(251, 191, 36, .05);
      border: 1px solid rgba(251, 191, 36, .2);
      border-radius: 14px;
      padding: 20px 22px;
    }

    .golden h3 {
      font-size: 1rem;
      color: var(--yellow);
      margin-bottom: 12px;
    }

    .rule-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .rule-row {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      background: var(--card2);
      border-radius: 10px;
      padding: 12px 14px;
    }

    .rule-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .rule-text {
      font-size: .84rem;
      color: var(--dim);
      line-height: 1.6;
    }

    .rule-text strong {
      color: var(--text);
    }

    /* NAV */
    .nav-bar {
      display: flex;
      gap: 12px;
      justify-content: center;
      padding: 24px;
      border-top: 1px solid var(--border);
    }

    .nav-btn {
      padding: 10px 22px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-family: 'Inter', sans-serif;
      font-size: .85rem;
      font-weight: 600;
      background: var(--card);
      color: var(--dim);
      cursor: pointer;
      text-decoration: none;
      transition: border-color .2s, color .2s;
    }

    .nav-btn:hover {
      border-color: var(--red);
      color: var(--text);
    }

    .nav-btn.primary {
      background: var(--red);
      color: #fff;
      border-color: var(--red);
    }

    /* ‚îÄ‚îÄ MOBILE RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      .hero h1 {
        font-size: 1.6rem !important;
      }

      .hero p {
        font-size: .88rem !important;
      }

      .page {
        padding: 24px 16px !important;
      }

      .two-col {
        grid-template-columns: 1fr !important;
      }

      .stats {
        flex-wrap: wrap;
        gap: 12px;
      }

      .code,
      pre {
        font-size: .7rem !important;
      }

      .nav-bar,
      [style*="justify-content:center"][style*="padding:24px"] {
        flex-direction: column;
        align-items: center;
      }
    }

    @media (max-width: 480px) {
      .hero {
        padding: 40px 16px 32px !important;
      }

      .hero h1 {
        font-size: 1.3rem !important;
      }

      section {
        margin-bottom: 24px !important;
      }
    }
  </style>
  <script src="config.js"></script>
  <script src="progress.js"></script>

</head>

<body>

  <div class="hero">
    <div class="hero-tag">üéì Lesson 5</div>
    <h1>Error Handling &amp; Auto-Reconnect üîÑ</h1>
    <p>Real apps never assume the connection stays up forever. Learn to detect failures and bounce back automatically.
    </p>

    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:16px">
      <span
        style="display:inline-flex;align-items:center;gap:5px;padding:5px 14px;border-radius:99px;font-size:.76rem;font-weight:700;background:rgba(255,255,255,.03);color:var(--text);border:1px solid #fbbf2430">üü°
        Intermediate</span>
      <span
        style="display:inline-flex;align-items:center;gap:5px;padding:5px 14px;border-radius:99px;font-size:.76rem;font-weight:600;background:rgba(255,255,255,.03);color:var(--text);border:1px solid rgba(255,255,255,0.06)">‚è±Ô∏è
        ~10 min read</span>
      <a href="learn4.html"
        style="display:inline-flex;align-items:center;gap:5px;padding:5px 14px;border-radius:99px;font-size:.76rem;font-weight:600;background:rgba(255,255,255,.03);color:var(--text);border:1px solid rgba(255,255,255,0.06);text-decoration:none">üîó
        Prereq: Lesson 4: Chat App</a>
    </div>
  </div>

  <div class="page">

    <!-- ‚ë† WHY CONNECTIONS FAIL -->
    <section>
      <div class="sec-label">
        <div class="sec-num c-red">1</div>
        <div>
          <div class="sec-title">Why connections fail üí•</div>
          <div class="sec-sub">This happens all the time ‚Äî you need to handle it</div>
        </div>
      </div>

      <div class="two-col">
        <div class="box">
          <div class="box-head c-red">‚ùå Common failure reasons</div>
          <div class="box-body">
            <div class="hl-box red">
              <strong class="c-red">Server crashes</strong> ‚Äî Node.js process dies, server restarts.<br><br>
              <strong class="c-red">Network drops</strong> ‚Äî WiFi disconnects, phone switches from 4G to
              WiFi.<br><br>
              <strong class="c-red">Idle timeout</strong> ‚Äî Load balancers kill connections silent after ~60s
              of no traffic.<br><br>
              <strong class="c-red">Browser goes to sleep</strong> ‚Äî Tab backgrounded, phone locked.
            </div>
          </div>
        </div>
        <div class="box">
          <div class="box-head c-yellow">üîî The two events to watch</div>
          <div class="box-body">
            <p class="mb-12">WebSocket gives you exactly 2 events for failure:</p>
            <div class="hl-box yellow">
              <strong class="c-yellow">onerror / 'error'</strong><br>
              Fires when the connection <em>fails to open</em>, or something goes wrong mid-connection. Always followed
              by a close event.
            </div>
            <div class="hl-box red mt-10">
              <strong class="c-red">onclose / 'close'</strong><br>
              Fires whenever the connection ends ‚Äî whether intentional (you called <code>ws.close()</code>) or because
              of an error. Check <code>event.wasClean</code> to tell them apart.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ‚ë° CLOSE CODES -->
    <section>
      <div class="sec-label">
        <div class="sec-num c-yellow">2</div>
        <div>
          <div class="sec-title">Close Codes ‚Äî reading the cause üìã</div>
          <div class="sec-sub">The close event tells you exactly WHY it closed</div>
        </div>
      </div>

      <div class="box">
        <div class="box-head c-yellow">üìñ event.code ‚Äî the most important property</div>
        <div class="box-body">
          <p class="mb-14">When <code class="mono">close</code> fires you get an event
            object with 3 useful properties:</p>
          <div class="code mb-14">
            ws.<span class="fn">addEventListener</span>(<span class="str">'close'</span>, (event) => {<br>
            &nbsp;&nbsp;<span class="fn">console</span>.<span class="fn">log</span>(event.<span class="kw">code</span>);
            <span class="cm">// number: 1000, 1001, 1006 ‚Ä¶</span><br>
            &nbsp;&nbsp;<span class="fn">console</span>.<span class="fn">log</span>(event.<span
              class="kw">reason</span>); <span class="cm">// string: human reason (often empty)</span><br>
            &nbsp;&nbsp;<span class="fn">console</span>.<span class="fn">log</span>(event.<span
              class="kw">wasClean</span>); <span class="cm">// true = intentional, false = crash/network drop</span><br>
            });
          </div>
          <table class="close-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Name</th>
                <th>What it means</th>
                <th>Reconnect?</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1000</td>
                <td>Normal Closure</td>
                <td>Intentional close ‚Äî both sides agreed</td>
                <td>‚ùå No</td>
              </tr>
              <tr>
                <td>1001</td>
                <td>Going Away</td>
                <td>Page navigated / server shutting down</td>
                <td>‚ö†Ô∏è Maybe</td>
              </tr>
              <tr>
                <td>1006</td>
                <td>Abnormal Closure</td>
                <td>Connection dropped ‚Äî no close frame sent</td>
                <td>‚úÖ Yes</td>
              </tr>
              <tr>
                <td>1011</td>
                <td>Internal Error</td>
                <td>Server had an unexpected error</td>
                <td>‚úÖ Yes</td>
              </tr>
              <tr>
                <td>1012</td>
                <td>Service Restart</td>
                <td>Server is restarting (planned)</td>
                <td>‚úÖ Yes</td>
              </tr>
              <tr>
                <td>4000‚Äì4999</td>
                <td>Custom codes</td>
                <td>App-defined (e.g. 4001 = Auth failed)</td>
                <td>Depends</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ‚ë¢ EXPONENTIAL BACKOFF -->
    <section>
      <div class="sec-label">
        <div class="sec-num c-green">3</div>
        <div>
          <div class="sec-title">Exponential Backoff ‚Äî the smart way to retry ‚è±Ô∏è</div>
          <div class="sec-sub">Never hammer a crashed server. Wait longer each time.</div>
        </div>
      </div>

      <div class="two-col">
        <div>
          <div class="box">
            <div class="box-head c-red">‚ùå Bad: Retry immediately forever</div>
            <div class="box-body">
              <div class="code">
                ws.<span class="fn">addEventListener</span>(<span class="str">'close'</span>, () => {<br>
                &nbsp;&nbsp;<span class="cm">// BAD ‚Äî hammers server 100x/sec!</span><br>
                &nbsp;&nbsp;<span class="fn">connect</span>();<br>
                });
              </div>
              <p class="note-sm mt-12">If 1000 users all reconnect instantly when a server restarts,
                the server gets <strong class="c-red">1000 connections in 1ms</strong> ‚Äî it crashes again
                immediately üò±</p>
            </div>
          </div>
        </div>
        <div>
          <div class="box">
            <div class="box-head c-green">‚úÖ Good: Exponential Backoff</div>
            <div class="box-body">
              <div class="code">
                <span class="cm">// Wait longer with each retry</span><br>
                <span class="cm">// Retry 1: 1s, Retry 2: 2s, Retry 3: 4s ‚Ä¶</span><br>
                <span class="kw">const</span> delay = <span class="fn">Math.min</span>(<br>
                &nbsp;&nbsp;<span class="num">1000</span> * <span class="num">2</span> ** retries,<br>
                &nbsp;&nbsp;<span class="num">30000</span> <span class="cm">// cap at 30s max</span><br>
                );
              </div>
              <p class="note-sm mt-12">Users are spread out over time. By <strong class="c-green">retry 5</strong>
                you're only reconnecting every <strong>32
                  seconds</strong>.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Backoff Visualiser -->
      <div class="box mt">
        <div class="box-head c-green">üìä Backoff delay per retry ‚Äî visualised</div>
        <div class="box-body">
          <div class="backoff-vis" id="backoffVis"></div>
          <p class="note-muted mt-12">Formula: <code
              class="mono">delay = Math.min(1000 √ó 2<sup>retries</sup>, 30000)</code> ‚Äî capped at 30s
            so it never waits forever.</p>
        </div>
      </div>
    </section>

    <!-- ‚ë£ THE FULL PATTERN -->
    <section>
      <div class="sec-label">
        <div class="sec-num c-blue">4</div>
        <div>
          <div class="sec-title">The Full Pattern ‚Äî production-ready code üíª</div>
          <div class="sec-sub">Copy this into any real WebSocket app</div>
        </div>
      </div>

      <div class="box">
        <div class="box-head c-blue">&lt;/&gt; Auto-reconnect with exponential backoff</div>
        <div class="box-body">
          <div class="code">
            <span class="kw">let</span> ws, retries = <span class="num">0</span>, maxRetries = <span
              class="num">8</span>;<br>
            <span class="kw">let</span> retryTimer = <span class="kw">null</span>;<br><br>

            <span class="kw">function</span> <span class="fn">connect</span>() {<br>
            &nbsp;&nbsp;ws = <span class="kw">new</span> <span class="fn">WebSocket</span>(<span
              class="str">getWsUrl(8082)</span>);<br><br>

            &nbsp;&nbsp;ws.<span class="fn">addEventListener</span>(<span class="str">'open'</span>, () => {<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="fn">console</span>.<span class="fn">log</span>(<span class="str">'‚úÖ
              Connected!'</span>);<br>
            &nbsp;&nbsp;&nbsp;&nbsp;retries = <span class="num">0</span>; <span class="cm">// reset on
              success!</span><br>
            &nbsp;&nbsp;});<br><br>

            &nbsp;&nbsp;ws.<span class="fn">addEventListener</span>(<span class="str">'close'</span>, (event) => {<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="cm">// 1000 = intentional close, don't reconnect</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="kw">if</span> (event.code === <span class="num">1000</span>) <span
              class="kw">return</span>;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="kw">if</span> (retries >= maxRetries) {<br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="fn">console</span>.<span class="fn">log</span>(<span
              class="str">'‚ùå Gave up after 8 retries'</span>); <span class="kw">return</span>;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;}<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="kw">const</span> delay = <span class="fn">Math.min</span>(<span
              class="num">1000</span> * <span class="num">2</span> ** retries, <span class="num">30000</span>);<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="fn">console</span>.<span class="fn">log</span>(<span class="str">`üîÑ
              Retry ${retries+1} in ${delay/1000}s‚Ä¶`</span>);<br>
            &nbsp;&nbsp;&nbsp;&nbsp;retries++;<br>
            &nbsp;&nbsp;&nbsp;&nbsp;retryTimer = <span class="fn">setTimeout</span>(<span class="fn">connect</span>,
            delay);<br>
            &nbsp;&nbsp;});<br><br>

            &nbsp;&nbsp;ws.<span class="fn">addEventListener</span>(<span class="str">'error'</span>, (e) => {<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="fn">console</span>.<span class="fn">error</span>(<span class="str">'‚ö†Ô∏è
              WebSocket error'</span>, e);<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="cm">// error is always followed by close ‚Äî reconnect there</span><br>
            &nbsp;&nbsp;});<br>
            }<br><br>

            <span class="fn">connect</span>(); <span class="cm">// kick it off</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ‚ë§ LIVE DEMO -->
    <section>
      <div class="sec-label">
        <div class="sec-num c-red">5</div>
        <div>
          <div class="sec-title">‚ñ∂Ô∏è Try it ‚Äî Simulate a crash &amp; watch it reconnect</div>
          <div class="sec-sub">Use the buttons to kill the connection and watch auto-reconnect work</div>
        </div>
      </div>

      <div class="demo-shell">
        <div class="demo-topbar">
          <div class="dot" id="demoDot"></div>
          <div class="status-text" id="demoStatus">Not connected</div>
          <div class="retry-badge" id="retryBadge">Retrying...</div>
          <div class="countdown-wrap" id="countdownWrap" style="display:none">
            Next retry in <span class="countdown-num" id="countdown">‚Äî</span>s
          </div>
        </div>

        <div class="demo-log" id="demoLog">
          <div class="lg sys"><span class="lg-t">‚Äî</span><span class="lg-m">üëã Press "Connect" to start. Then try
              "Simulate Crash" to see auto-reconnect!</span></div>
        </div>

        <div class="demo-controls">
          <button class="btn btn-green" id="dBtnConn" onclick="demoConnect()">Connect</button>
          <button class="btn btn-red" id="dBtnCrash" onclick="demoCrash()" disabled>Simulate Crash</button>
          <button class="btn btn-ghost" id="dBtnClose" onclick="demoClose()" disabled>Clean Close</button>
          <button class="btn btn-ghost" onclick="demoLog.innerHTML=''">Clear</button>
          <button class="btn btn-ghost" id="dBtnStop" onclick="demoStop()" disabled>Stop Retrying</button>
          <div class="countdown-wrap" id="countdownInline" style="display:none">
            Next retry in <span class="countdown-num" id="countdown2">‚Äî</span>s
          </div>
        </div>
      </div>
    </section>

    <!-- GOLDEN RULES -->
    <section>
      <div class="sec-label">
        <div class="sec-num c-yellow">6</div>
        <div>
          <div class="sec-title">‚ö° Golden Rules of Error Handling</div>
          <div class="sec-sub">Memorise these ‚Äî they apply to every WebSocket app</div>
        </div>
      </div>

      <div class="golden">
        <h3>‚úÖ Production Checklist</h3>
        <div class="rule-list">
          <div class="rule-row">
            <div class="rule-icon">üîÑ</div>
            <div class="rule-text"><strong>Always use exponential backoff</strong> ‚Äî never reconnect immediately. Start
              at 1s, double each time, cap at 30s.</div>
          </div>
          <div class="rule-row">
            <div class="rule-icon">üî¢</div>
            <div class="rule-text"><strong>Set a max retry limit</strong> (e.g. 8 retries). After that, show the user a
              message: "Connection lost. Refresh the page."</div>
          </div>
          <div class="rule-row">
            <div class="rule-icon">‚úÖ</div>
            <div class="rule-text"><strong>Reset the retry counter on success</strong> ‚Äî if a reconnect succeeds, set
              <code style="font-family:monospace">retries = 0</code> so the next failure starts fresh.
            </div>
          </div>
          <div class="rule-row">
            <div class="rule-icon">üö´</div>
            <div class="rule-text"><strong>Don't reconnect on code 1000</strong> ‚Äî that's an intentional close (e.g.
              user logged out). Only auto-reconnect on unexpected closes.</div>
          </div>
          <div class="rule-row">
            <div class="rule-icon">üí¨</div>
            <div class="rule-text"><strong>Show the user what's happening</strong> ‚Äî display a "Reconnecting..." badge
              so they know the app is working, not broken.</div>
          </div>
          <div class="rule-row">
            <div class="rule-icon">üßπ</div>
            <div class="rule-text"><strong>Clear the retry timer on clean close</strong> ‚Äî always call <code
                style="font-family:monospace">clearTimeout(retryTimer)</code> when the user intentionally disconnects.
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>






  <!-- ‚úèÔ∏è LIVE CODE PLAYGROUND -->
  <div style="max-width:880px;margin:0 auto;padding:0 24px 28px">
    <div style="background:transparent;border:1px solid rgba(255,255,255,0.06);border-radius:14px;overflow:hidden">
      <div
        style="padding:12px 18px;border-bottom:1px solid #1f2d45;font-weight:700;font-size:.95rem;color:var(--text);display:flex;align-items:center;justify-content:space-between">
        <span>‚úèÔ∏è Try It ‚Äî Exponential Backoff Calculator</span>
        <div style="display:flex;gap:8px">
          <button onclick="pg_27673_reset()"
            style="padding:5px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#94a3b8;font-size:.75rem;font-weight:600;cursor:pointer;font-family:Inter,sans-serif">‚Ü∫
            Reset</button>
          <button onclick="pg_27673_run()"
            style="padding:5px 16px;border-radius:6px;border:none;background:#22c55e;color:#052e16;font-size:.75rem;font-weight:700;cursor:pointer;font-family:Inter,sans-serif">‚ñ∂
            Run</button>
        </div>
      </div>
      <textarea id="pg_27673_code" spellcheck="false"
        style="width:100%;min-height:200px;padding:14px 18px;font-family:'Fira Code',monospace;font-size:.78rem;background:rgba(0,0,0,0.15);color:var(--text);border:none;outline:none;resize:vertical;line-height:1.7;tab-size:2;box-sizing:border-box"></textarea>
      <div
        style="padding:8px 18px;border-top:1px solid #1f2d45;background:rgba(0,0,0,0.15);font-size:.72rem;color:#64748b;display:flex;justify-content:space-between">
        <span>Console Output ‚Üì</span>
        <button onclick="document.getElementById('pg_27673_output').innerHTML=''"
          style="background:none;border:none;color:#64748b;cursor:pointer;font-size:.72rem;font-family:Inter,sans-serif">Clear</button>
      </div>
      <div id="pg_27673_output"
        style="min-height:80px;max-height:200px;overflow-y:auto;padding:10px 18px;font-family:'Fira Code',monospace;font-size:.75rem;color:#94a3b8;background:#080d14;line-height:1.7">
      </div>
    </div>
  </div>
  <script>
    (function () {
      const defaultCode = `// No server needed! This calculates backoff delays.
// Try changing MAX_RETRIES or the base delay.

const MAX_RETRIES = 8;
const BASE_DELAY = 1000;  // 1 second
const MAX_DELAY = 30000;  // 30 seconds

for (let i = 0; i < MAX_RETRIES; i++) {
  const delay = Math.min(BASE_DELAY * 2 ** i, MAX_DELAY);
  log('Retry #' + (i+1) + ': wait ' + (delay/1000) + 's');
}

log('');
log('Total wait: ' + 
  Array.from({length: MAX_RETRIES}, (_, i) => 
    Math.min(BASE_DELAY * 2 ** i, MAX_DELAY)
  ).reduce((a, b) => a + b, 0) / 1000 + 's'
);`;
      const codeEl = document.getElementById('pg_27673_code');
      const outEl = document.getElementById('pg_27673_output');
      codeEl.value = defaultCode;

      // Tab support in textarea
      codeEl.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          e.preventDefault();
          const s = codeEl.selectionStart;
          codeEl.value = codeEl.value.substring(0, s) + '  ' + codeEl.value.substring(codeEl.selectionEnd);
          codeEl.selectionStart = codeEl.selectionEnd = s + 2;
        }
      });

      window.pg_27673_run = function () {
        outEl.innerHTML = '';
        const code = codeEl.value;
        // Create a sandboxed log function
        const log = (msg) => {
          const line = document.createElement('div');
          line.style.padding = '2px 0';
          line.style.borderBottom = '1px solid rgba(255,255,255,.04)';
          line.textContent = String(msg);
          outEl.appendChild(line);
          outEl.scrollTop = outEl.scrollHeight;
        };
        try {
          const fn = new Function('log', code);
          fn(log);
        } catch (err) {
          const errLine = document.createElement('div');
          errLine.style.color = '#f87171';
          errLine.textContent = '‚ùå Error: ' + err.message;
          outEl.appendChild(errLine);
        }
      };

      window.pg_27673_reset = function () {
        codeEl.value = defaultCode;
        outEl.innerHTML = '';
      };
    })();
  </script>




  <div
    style="display:flex;gap:12px;align-items:flex-start;padding:10px 14px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.06)">
    <span style="font-size:1.3rem;flex-shrink:0;margin-top:2px">üì∫</span>
    <div>
      <div style="font-weight:700;font-size:.85rem;color:var(--text);margin-bottom:3px">Netflix</div>
      <div style="font-size:.82rem;color:#94a3b8;line-height:1.6">When streaming hiccups occur, Netflix reconnects with
        backoff. The close code tells the client whether to try a different CDN server or show an error.</div>
    </div>
  </div>
  <div
    style="display:flex;gap:12px;align-items:flex-start;padding:10px 14px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.06)">
    <span style="font-size:1.3rem;flex-shrink:0;margin-top:2px">üí∞</span>
    <div>
      <div style="font-weight:700;font-size:.85rem;color:var(--text);margin-bottom:3px">Trading Platforms (Interactive
        Brokers)</div>
      <div style="font-size:.82rem;color:#94a3b8;line-height:1.6">A dropped connection during a trade is catastrophic.
        Auto-reconnect with backoff ensures traders never miss a market-moving event for more than seconds.</div>
    </div>
  </div>
  <div
    style="display:flex;gap:12px;align-items:flex-start;padding:10px 14px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.06)">
    <span style="font-size:1.3rem;flex-shrink:0;margin-top:2px">üéÆ</span>
    <div>
      <div style="font-weight:700;font-size:.85rem;color:var(--text);margin-bottom:3px">Online Games (League of Legends)
      </div>
      <div style="font-size:.82rem;color:#94a3b8;line-height:1.6">The "Attempting to Reconnect" banner uses exponential
        backoff. Clean close (surrender/end) uses code 1000; network drop triggers reconnect.</div>
    </div>
  </div>
  <div
    style="display:flex;gap:12px;align-items:flex-start;padding:10px 14px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.06)">
    <span style="font-size:1.3rem;flex-shrink:0;margin-top:2px">‚òÅÔ∏è</span>
    <div>
      <div style="font-weight:700;font-size:.85rem;color:var(--text);margin-bottom:3px">Google Cloud Pub/Sub</div>
      <div style="font-size:.82rem;color:#94a3b8;line-height:1.6">Google's official client libraries implement
        exponential backoff with jitter (random delay) to prevent thousands of clients from reconnecting at the exact
        same moment.</div>
    </div>
  </div>
  </div>
  </div>
  </div>

  <!-- ‚úÖ MARK COMPLETE -->
  <div style="max-width:880px;margin:0 auto;padding:0 24px 20px">
    <button id="markCompleteBtn" onclick="toggleLessonComplete()"
      style="width:100%;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,.03);color:var(--dim);font-family:Inter,sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px">
      <span id="markCompleteIcon">‚òê</span>
      <span id="markCompleteText">Mark Lesson 5 as Complete</span>
    </button>
  </div>
  <script>
    function toggleLessonComplete() {
      const result = WSProgress.toggleComplete(5);
      updateCompleteButton(result.isComplete);
    }
    function updateCompleteButton(isComplete) {
      const btn = document.getElementById('markCompleteBtn');
      const icon = document.getElementById('markCompleteIcon');
      const text = document.getElementById('markCompleteText');
      if (isComplete) {
        btn.style.background = 'rgba(34,197,94,.18)';
        btn.style.borderColor = '#22c55e';
        icon.textContent = '‚úÖ';
        text.textContent = 'Lesson 5 Complete!';
      } else {
        btn.style.background = 'rgba(34,197,94,.08)';
        btn.style.borderColor = '#22c55e';
        icon.textContent = '‚òê';
        text.textContent = 'Mark Lesson 5 as Complete';
      }
    }
    // Check on load
    document.addEventListener('DOMContentLoaded', () => {
      const completed = WSProgress.getCompleted();
      updateCompleteButton(completed.has(5));
    });
  </script>


  </div>


  <!-- üèóÔ∏è STORY-DRIVEN SCENARIO IMPLEMENTATION -->
  <div style="max-width:880px;margin:0 auto;padding:0 24px 28px">
    <div
      style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);">
      <div
        style="padding:16px 20px;border-bottom:1px solid var(--border);font-weight:700;font-size:1.05rem;color:var(--text);display:flex;align-items:center;gap:8px; background:var(--card2)">
        <span>üèóÔ∏è</span>
        <span>Scenario 1: GPS Fleet Tracker & The Thundering Herd (Uber)</span>
      </div>
      <div style="padding:20px">
        <div style="margin-bottom:22px">
          <div
            style="font-size:.75rem;text-transform:uppercase;letter-spacing:1px;font-weight:800;color:var(--blue);margin-bottom:8px">
            üìñ The Logic & Flow</div>
          <div style="font-size:.9rem;color:var(--dim);line-height:1.75">**The Business Problem:** Imagine 10,000 Uber
            drivers are parked near a stadium after a concert. The cell tower gets overwhelmed and abruptly drops all
            10,000 TCP connections. If the Uber app is hardcoded to `reconnect() -> delay 1000ms`, then exactly 1 second
            later, 10,000 phones will blast the backend servers simultaneously, creating a self-inflicted DDOS attack
            that will crush the infrastructure.<br><br>**The End-to-End Flow:** To solve this 'Thundering Herd' problem,
            architects use **Exponential Backoff with Jitter**. When the driver's phone loses connection, it waits 1
            second. If that fails, it waits 2 seconds, then 4s, 8s, up to 30s. Crucially, the app adds 'Jitter' (a
            random delay between 0 and 1000ms) to the backoff. Driver A waits 2.4s, Driver B waits 2.1s, Driver C waits
            2.9s. This mathematically spreads out the 10,000 reconnect attempts into a smooth trickle that the
            load-balancers can handle easily.</div>
        </div>
        <div>
          <div
            style="font-size:.75rem;text-transform:uppercase;letter-spacing:1px;font-weight:800;color:var(--blue);margin-bottom:8px">
            üíª Implementation Code</div>
          <pre
            style="margin:0;padding:16px;background:#f8fafc;border:1px solid var(--border);border-radius:8px;font-family:'Fira Code',monospace;font-size:.8rem;color:#334155;overflow-x:auto;line-height:1.8"><code>let retryCount = 0;

function connectToDispatch() {
  const ws = new WebSocket('wss://driver-api.uber.com/tracker');
  
  // Successful connection? Reset the counter!
  ws.onopen = () =&gt; { retryCount = 0; };
  
  ws.onclose = () =&gt; {
    // 1. Exponential Backoff: Double the delay each time (capped at 30s)
    let baseDelay = Math.min(1000 * Math.pow(2, retryCount), 30000);
    
    // 2. Jitter: Add up to 500ms of pure randomness
    let jitter = Math.random() * 500; 
    
    console.log(`Connection dropped. Retrying in ${(baseDelay+jitter)/1000}s`);
    
    setTimeout(() =&gt; {
      retryCount++;
      connectToDispatch(); // Recursive attempt
    }, baseDelay + jitter);
  };
}</code></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- üèóÔ∏è STORY-DRIVEN SCENARIO IMPLEMENTATION -->
  <div style="max-width:880px;margin:0 auto;padding:0 24px 28px">
    <div
      style="background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);">
      <div
        style="padding:16px 20px;border-bottom:1px solid var(--border);font-weight:700;font-size:1.05rem;color:var(--text);display:flex;align-items:center;gap:8px; background:var(--card2)">
        <span>üèóÔ∏è</span>
        <span>Scenario 2: Video Stream Quality Downgrader (Netflix)</span>
      </div>
      <div style="padding:20px">
        <div style="margin-bottom:22px">
          <div
            style="font-size:.75rem;text-transform:uppercase;letter-spacing:1px;font-weight:800;color:var(--blue);margin-bottom:8px">
            üìñ The Logic & Flow</div>
          <div style="font-size:.9rem;color:var(--dim);line-height:1.75">**The Business Problem:** During peak evening
            hours, a CDN edge server might hit 99% CPU utilization. It cannot parse WebSocket ping/pong frames fast
            enough, causing thousands of connections to lag. The server must proactively shed load without breaking the
            user experience entirely by kicking them to the login screen.<br><br>**The End-to-End Flow:** The server
            explicitly severs connections to the heaviest users (those streaming 4K), but it doesn't just cut the wire;
            it sends a formal WebSocket Close Frame with a specific code: **1011 (Internal Server Error)**. The
            browser's Javascript catches this exact code in the `onclose` event. Knowing the server is drowning, the
            client logic purposefully lowers its video quality request to 480p, waits 5 seconds, and then attempts
            reconnecting to a *different* backup server URL.</div>
        </div>
        <div>
          <div
            style="font-size:.75rem;text-transform:uppercase;letter-spacing:1px;font-weight:800;color:var(--blue);margin-bottom:8px">
            üíª Implementation Code</div>
          <pre
            style="margin:0;padding:16px;background:#f8fafc;border:1px solid var(--border);border-radius:8px;font-family:'Fira Code',monospace;font-size:.8rem;color:#334155;overflow-x:auto;line-height:1.8"><code>ws.onclose = (event) =&gt; {
  // Code 1011: The server explicitly told us it is dying
  if (event.code === 1011) {
    console.warn("Primary server overloaded! Degrading gracefully.");
    
    videoPlayer.setResolution('480p'); // Save bandwidth
    
    setTimeout(() =&gt; {
      // Connect to a known-good backup cluster
      connectToStream('wss://backup-edge-server.cdn.com');
    }, 5000);
  } else {
    // Standard Wi-Fi drop? Just do normal exponential backoff
    standardReconnect();
  }
};</code></pre>
        </div>
      </div>
    </div>
  </div>
  <!-- üß† TEST YOURSELF QUIZ -->
  <div style="max-width:880px;margin:0 auto;padding:0 24px 32px">
    <div style="background:transparent;border:1px solid rgba(255,255,255,0.06);border-radius:14px;overflow:hidden">
      <div
        style="padding:14px 18px;border-bottom:1px solid #1f2d45;font-weight:700;font-size:.95rem;color:var(--text);display:flex;align-items:center;justify-content:space-between">
        <span>üß† Test Yourself</span>
        <span id="quiz_9817_score" style="font-size:.8rem;color:#94a3b8">0/4 answered</span>
      </div>
      <div style="padding:18px">
        <div id="quiz_9817_q0" style="margin-bottom:20px">
          <div style="font-size:.88rem;font-weight:600;color:var(--text);margin-bottom:10px">1. Close code
            <code>1000</code> means‚Ä¶
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button id="quiz_9817_q0_o0" onclick="quiz_9817_check(0,0)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">A. Connection
              error</button>
            <button id="quiz_9817_q0_o1" onclick="quiz_9817_check(0,1)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">B. Server
              crashed</button>
            <button id="quiz_9817_q0_o2" onclick="quiz_9817_check(0,2)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">C. Normal,
              intentional close</button>
            <button id="quiz_9817_q0_o3" onclick="quiz_9817_check(0,3)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">D.
              Timeout</button>
          </div>
          <div id="quiz_9817_q0_explain"
            style="display:none;margin-top:8px;padding:10px 14px;border-radius:8px;font-size:.82rem;line-height:1.6">
          </div>
        </div>
        <div id="quiz_9817_q1" style="margin-bottom:20px">
          <div style="font-size:.88rem;font-weight:600;color:var(--text);margin-bottom:10px">2. What is exponential
            backoff?</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button id="quiz_9817_q1_o0" onclick="quiz_9817_check(1,0)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">A. Retrying
              faster each time</button>
            <button id="quiz_9817_q1_o1" onclick="quiz_9817_check(1,1)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">B. Waiting
              longer between each retry (1s, 2s, 4s, 8s...)</button>
            <button id="quiz_9817_q1_o2" onclick="quiz_9817_check(1,2)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">C.
              Disconnecting after one failure</button>
            <button id="quiz_9817_q1_o3" onclick="quiz_9817_check(1,3)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">D. Sending
              multiple connection requests at once</button>
          </div>
          <div id="quiz_9817_q1_explain"
            style="display:none;margin-top:8px;padding:10px 14px;border-radius:8px;font-size:.82rem;line-height:1.6">
          </div>
        </div>
        <div id="quiz_9817_q2" style="margin-bottom:20px">
          <div style="font-size:.88rem;font-weight:600;color:var(--text);margin-bottom:10px">3. Should you put reconnect
            logic in the <code>error</code> event?</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button id="quiz_9817_q2_o0" onclick="quiz_9817_check(2,0)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">A. Yes,
              always</button>
            <button id="quiz_9817_q2_o1" onclick="quiz_9817_check(2,1)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">B. No ‚Äî put
              it in the close event</button>
            <button id="quiz_9817_q2_o2" onclick="quiz_9817_check(2,2)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">C. It doesn't
              matter</button>
            <button id="quiz_9817_q2_o3" onclick="quiz_9817_check(2,3)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">D. Only on
              the server</button>
          </div>
          <div id="quiz_9817_q2_explain"
            style="display:none;margin-top:8px;padding:10px 14px;border-radius:8px;font-size:.82rem;line-height:1.6">
          </div>
        </div>
        <div id="quiz_9817_q3" style="margin-bottom:20px">
          <div style="font-size:.88rem;font-weight:600;color:var(--text);margin-bottom:10px">4. What formula gives you
            capped exponential backoff?</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button id="quiz_9817_q3_o0" onclick="quiz_9817_check(3,0)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">A. retries *
              1000</button>
            <button id="quiz_9817_q3_o1" onclick="quiz_9817_check(3,1)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">B.
              Math.min(1000 * 2 ** retries, 30000)</button>
            <button id="quiz_9817_q3_o2" onclick="quiz_9817_check(3,2)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">C.
              Math.random() * 5000</button>
            <button id="quiz_9817_q3_o3" onclick="quiz_9817_check(3,3)"
              style="text-align:left;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#cbd5e1;font-family:Inter,sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s"
              onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#1f2d45'">D. retries +
              1000</button>
          </div>
          <div id="quiz_9817_q3_explain"
            style="display:none;margin-top:8px;padding:10px 14px;border-radius:8px;font-size:.82rem;line-height:1.6">
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function () {
      const answers = [2, 1, 1, 1];
      const explains = ['Code 1000 = clean, intentional close. Both sides agreed to disconnect. No need to reconnect.', 'Exponential backoff doubles the wait time between retries, avoiding flooding a struggling server.', 'The error event is always followed by a close event. Put reconnect logic in close to avoid double-reconnecting.', 'This doubles the delay each retry (1s‚Üí2s‚Üí4s‚Üí8s) but caps it at 30 seconds to avoid absurd waits.'];
      let answered = new Set();
      let correct = 0;
      window.quiz_9817_check = function (qi, oi) {
        if (answered.has(qi)) return;
        answered.add(qi);
        const isCorrect = oi === answers[qi];
        if (isCorrect) correct++;
        // Style the selected option
        const btn = document.getElementById("quiz_9817_q" + qi + "_o" + oi);
        btn.style.background = isCorrect ? "rgba(34,197,94,.15)" : "rgba(248,113,113,.15)";
        btn.style.borderColor = isCorrect ? "#22c55e" : "#f87171";
        btn.style.color = isCorrect ? "#22c55e" : "#f87171";
        btn.textContent = (isCorrect ? "‚úÖ " : "‚ùå ") + btn.textContent;
        // If wrong, highlight correct answer
        if (!isCorrect) {
          const correctBtn = document.getElementById("quiz_9817_q" + qi + "_o" + answers[qi]);
          correctBtn.style.background = "rgba(34,197,94,.15)";
          correctBtn.style.borderColor = "#22c55e";
          correctBtn.style.color = "#22c55e";
        }
        // Disable all options for this question
        for (let j = 0; j < 4; j++) {
          const b = document.getElementById("quiz_9817_q" + qi + "_o" + j);
          if (b) b.style.pointerEvents = "none";
        }
        // Show explanation
        const exp = document.getElementById("quiz_9817_q" + qi + "_explain");
        exp.style.display = "block";
        exp.style.background = isCorrect ? "rgba(34,197,94,.08)" : "rgba(248,113,113,.08)";
        exp.style.borderLeft = "3px solid " + (isCorrect ? "#22c55e" : "#f87171");
        exp.style.color = "#cbd5e1";
        exp.innerHTML = (isCorrect ? "‚úÖ Correct! " : "‚ùå Not quite. ") + explains[qi];
        // Update score
        const scoreEl = document.getElementById("quiz_9817_score");
        scoreEl.textContent = correct + "/4 correct";
        if (answered.size === 4) {
          scoreEl.style.color = correct === 4 ? "#22c55e" : correct >= 3 ? "#fbbf24" : "#f87171";
          scoreEl.style.fontWeight = "700";
        }
      };
    })();
  </script>

  <!-- ‚ïê‚ïê‚ïê BEGINNER REFERENCE SECTIONS ‚ïê‚ïê‚ïê -->
  <div style="max-width:880px;margin:0 auto;padding:0 24px 32px">
    <!-- üìã Quick Cheat Sheet -->
    <div
      style="background:transparent;border:1px solid rgba(255,255,255,0.06);border-radius:14px;overflow:hidden;margin-bottom:24px">
      <div style="padding:14px 18px;border-bottom:1px solid #1f2d45;font-weight:700;font-size:.95rem;color:var(--text)">
        üìã Quick Cheat Sheet ‚Äî Error Handling & Auto-Reconnect</div>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:.83rem">
          <thead>
            <tr>
              <th
                style="padding:10px 14px;background:rgba(255,255,255,0.02);color:#94a3b8;font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid #1f2d45;text-align:left">
                Code</th>
              <th
                style="padding:10px 14px;background:rgba(255,255,255,0.02);color:#94a3b8;font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid #1f2d45;text-align:left">
                What it does</th>
              <th
                style="padding:10px 14px;background:rgba(255,255,255,0.02);color:#94a3b8;font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid #1f2d45;text-align:left">
                When</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td
                style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:#7dd3fc;font-family:'Fira Code',monospace;font-size:.78rem">
                <code>event.code</code>
              </td>
              <td style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:var(--text)">Why the connection closed
                (1000=normal)</td>
              <td style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:#94a3b8;font-size:.78rem">In the close
                event</td>
            </tr>
            <tr>
              <td
                style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:#7dd3fc;font-family:'Fira Code',monospace;font-size:.78rem">
                <code>event.wasClean</code>
              </td>
              <td style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:var(--text)">true if server said
                goodbye properly</td>
              <td style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:#94a3b8;font-size:.78rem">In the close
                event</td>
            </tr>
            <tr>
              <td
                style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:#7dd3fc;font-family:'Fira Code',monospace;font-size:.78rem">
                <code>event.reason</code>
              </td>
              <td style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:var(--text)">Optional text explanation
              </td>
              <td style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:#94a3b8;font-size:.78rem">In the close
                event</td>
            </tr>
            <tr>
              <td
                style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:#7dd3fc;font-family:'Fira Code',monospace;font-size:.78rem">
                <code>Math.min(1000 * 2**n, 30000)</code>
              </td>
              <td style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:var(--text)">Exponential backoff
                formula</td>
              <td style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:#94a3b8;font-size:.78rem">Wait 1s, 2s,
                4s, 8s...</td>
            </tr>
            <tr>
              <td
                style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:#7dd3fc;font-family:'Fira Code',monospace;font-size:.78rem">
                <code>clearTimeout(timer)</code>
              </td>
              <td style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:var(--text)">Cancel a pending reconnect
              </td>
              <td style="padding:10px 14px;border-bottom:1px solid #1f2d45;color:#94a3b8;font-size:.78rem">When user
                disconnects manually</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- üí° Key Takeaways -->
    <div
      style="background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:18px 20px;margin-bottom:24px">
      <div style="font-weight:700;font-size:.95rem;color:var(--text);margin-bottom:12px">üí° Key Takeaways for Beginners
      </div>
      <div
        style="display:flex;gap:10px;align-items:flex-start;margin-bottom:10px;font-size:.86rem;color:#cbd5e1;line-height:1.65">
        <span style="color:var(--text);flex-shrink:0">‚ñ∏</span><span>Connections <strong>will</strong> drop ‚Äî WiFi
          changes, server restarts, timeouts. Your app must handle this gracefully.</span>
      </div>
      <div
        style="display:flex;gap:10px;align-items:flex-start;margin-bottom:10px;font-size:.86rem;color:#cbd5e1;line-height:1.65">
        <span style="color:var(--text);flex-shrink:0">‚ñ∏</span><span>Close code <code>1000</code> means
          <strong>intentional close</strong> ‚Äî don't auto-reconnect. Any other code = unexpected = try again.</span>
      </div>
      <div
        style="display:flex;gap:10px;align-items:flex-start;margin-bottom:10px;font-size:.86rem;color:#cbd5e1;line-height:1.65">
        <span style="color:var(--text);flex-shrink:0">‚ñ∏</span><span><strong>Exponential backoff</strong> = wait longer
          between each retry (1s ‚Üí 2s ‚Üí 4s ‚Üí 8s). This avoids flooding a struggling server.</span>
      </div>
      <div
        style="display:flex;gap:10px;align-items:flex-start;margin-bottom:10px;font-size:.86rem;color:#cbd5e1;line-height:1.65">
        <span style="color:var(--text);flex-shrink:0">‚ñ∏</span><span>Always set a <strong>max retry limit</strong> (e.g.,
          8 attempts). Don't retry forever ‚Äî tell the user if it's truly down.</span>
      </div>
      <div
        style="display:flex;gap:10px;align-items:flex-start;margin-bottom:10px;font-size:.86rem;color:#cbd5e1;line-height:1.65">
        <span style="color:var(--text);flex-shrink:0">‚ñ∏</span><span>The <code>error</code> event is <strong>always
            followed by close</strong>. Put your reconnect logic in <code>close</code>, not <code>error</code>.</span>
      </div>
    </div>

    <!-- üíª Production Pattern -->
    <div
      style="background:transparent;border:1px solid rgba(255,255,255,0.06);border-radius:14px;overflow:hidden;margin-bottom:24px">
      <div style="padding:14px 18px;border-bottom:1px solid #1f2d45;font-weight:700;font-size:.95rem;color:var(--text)">
        üíª Auto-reconnect with exponential backoff</div>
      <pre
        style="margin:0;padding:16px 18px;font-family:'Fira Code',monospace;font-size:.78rem;color:#94a3b8;overflow-x:auto;line-height:1.8;background:rgba(0,0,0,0.15)"><code>let ws, retries = 0;
const MAX_RETRIES = 8;  // Give up after 8 attempts
let retryTimer = null;

function connect() {
  ws = new WebSocket(getWsUrl(8080));

  ws.addEventListener('open', () => {
    console.log('‚úÖ Connected!');
    retries = 0;  // Reset counter on success!
  });

  ws.addEventListener('close', (event) => {
    // Code 1000 = user clicked disconnect. Don't retry.
    if (event.code === 1000) return;

    // Too many retries? Give up.
    if (retries >= MAX_RETRIES) {
      console.log('‚ùå Server unreachable after 8 tries');
      return;
    }

    // Exponential backoff: 1s, 2s, 4s, 8s, 16s, 30s max
    const delay = Math.min(1000 * 2 ** retries, 30000);
    console.log(`üîÑ Retry #${retries + 1} in ${delay/1000}s‚Ä¶`);
    retries++;
    retryTimer = setTimeout(connect, delay);
  });

  ws.addEventListener('error', () => {
    // Error always triggers close ‚Äî reconnect logic is there
    console.error('‚ö†Ô∏è Connection error');
  });
}

connect(); // Start the first connection</code></pre>
    </div>
  </div>

  <div class="nav-bar">
    <a href="index.html" class="nav-btn home">&#127968; Home</a>
    <a href="learn4.html" class="nav-btn">&#8592; Lesson 4</a>
    <a href="WEBSOCKET_STUDY_NOTES.md" class="nav-btn">&#128218; Notes</a>
    <a href="learn6.html" class="nav-btn primary">Lesson 6: Broadcasting &#8594;</a>
  </div>

  <script>
    // ‚îÄ‚îÄ Backoff visualiser ‚îÄ‚îÄ
    const bars = [
      { retries: 0, delay: 1 },
      { retries: 1, delay: 2 },
      { retries: 2, delay: 4 },
      { retries: 3, delay: 8 },
      { retries: 4, delay: 16 },
      { retries: 5, delay: 30 },
      { retries: 6, delay: 30 },
    ];
    const maxDelay = 30;
    const colours = ['#f87171', '#fb923c', '#fbbf24', '#a3e635', '#34d399', '#38bdf8', '#a78bfa'];
    const vis = document.getElementById('backoffVis');
    bars.forEach((b, i) => {
      const pct = (b.delay / maxDelay) * 90;
      vis.innerHTML += `
      <div class="backoff-bar-wrap">
        <div class="backoff-sec">${b.delay}s</div>
        <div class="backoff-bar" style="height:${pct}%;background:${colours[i]};opacity:.85"></div>
        <div class="backoff-label">#${b.retries + 1}</div>
      </div>`;
    });

    // ‚îÄ‚îÄ Live Demo ‚îÄ‚îÄ
    let ws = null, retries = 0, maxRetries = 6, retryTimer = null, countInterval = null;
    const log = document.getElementById('demoLog');

    function now() { return new Date().toLocaleTimeString('en-US', { hour12: false }); }

    function addLog(type, msg) {
      const d = document.createElement('div');
      d.className = `lg ${type}`;
      d.innerHTML = `<span class="lg-t">${now()}</span><span class="lg-m">${msg}</span>`;
      log.appendChild(d);
      log.scrollTop = log.scrollHeight;
    }

    function setDot(cls, status) {
      document.getElementById('demoDot').className = `dot ${cls}`;
      document.getElementById('demoStatus').textContent = status;
    }

    function showRetry(seconds) {
      document.getElementById('retryBadge').className = 'retry-badge show';
      document.getElementById('countdownInline').style.display = 'block';
      clearInterval(countInterval);
      let remaining = seconds;
      document.getElementById('countdown2').textContent = remaining;
      countInterval = setInterval(() => {
        remaining--;
        document.getElementById('countdown2').textContent = remaining;
        if (remaining <= 0) clearInterval(countInterval);
      }, 1000);
    }

    function hideRetry() {
      document.getElementById('retryBadge').className = 'retry-badge';
      document.getElementById('countdownInline').style.display = 'none';
      clearInterval(countInterval);
    }

    function setBtns(connected) {
      document.getElementById('dBtnConn').disabled = connected;
      document.getElementById('dBtnCrash').disabled = !connected;
      document.getElementById('dBtnClose').disabled = !connected;
    }

    function scheduleReconnect() {
      if (retries >= maxRetries) {
        addLog('err', `‚ùå Gave up after ${maxRetries} retries. Click Connect to try again.`);
        setDot('error', 'Failed ‚Äî gave up');
        document.getElementById('dBtnConn').disabled = false;
        document.getElementById('dBtnStop').disabled = true;
        hideRetry();
        return;
      }
      const delay = Math.min(1000 * Math.pow(2, retries), 30000);
      const secs = delay / 1000;
      addLog('warn', `üîÑ Retry #${retries + 1} in ${secs}s‚Ä¶ (backoff: 1s √ó 2^${retries} = ${secs}s)`);
      setDot('connecting', `Reconnecting in ${secs}s‚Ä¶`);
      showRetry(secs);
      retries++;
      document.getElementById('dBtnStop').disabled = false;
      retryTimer = setTimeout(demoConnectInternal, delay);
    }

    function demoConnectInternal() {
      hideRetry();
      if (ws && ws.readyState < 2) return;
      setDot('connecting', 'Connecting‚Ä¶');
      addLog('sys', `‚è≥ Attempting connection to ${getWsUrl(8080)}‚Ä¶`);
      ws = new WebSocket(getWsUrl(8080));

      ws.addEventListener('open', () => {
        setDot('open', 'Connected ‚úÖ');
        addLog('ok', `‚úÖ [open] Connected! retries reset to 0.`);
        retries = 0;
        setBtns(true);
        document.getElementById('dBtnStop').disabled = true;
        hideRetry();
      });

      ws.addEventListener('message', (e) => {
        let d; try { d = JSON.parse(e.data); } catch { d = e.data; }
        const txt = typeof d === 'object' ? (d.echo || d.message || JSON.stringify(d)) : d;
        addLog('recv', `üì® [message] ${txt}`);
      });

      ws.addEventListener('close', (event) => {
        ws = null;
        setBtns(false);
        if (event.code === 1000) {
          setDot('', 'Closed cleanly (code 1000)');
          addLog('sys', `üîå [close] Clean disconnect. code=1000, wasClean=${event.wasClean}. No reconnect.`);
          document.getElementById('dBtnStop').disabled = true;
          return;
        }
        addLog('err', `‚ö° [close] Unexpected! code=${event.code}, wasClean=${event.wasClean} ‚Äî scheduling reconnect‚Ä¶`);
        scheduleReconnect();
      });

      ws.addEventListener('error', () => {
        addLog('err', `‚ö†Ô∏è [error] Connection error. A close event will follow.`);
        setDot('error', 'Error');
      });
    }

    function demoConnect() {
      retries = 0;
      demoConnectInternal();
    }

    function demoCrash() {
      if (!ws) return;
      addLog('warn', `üí• Simulating crash ‚Äî forcibly closing with code 1006 (abnormal)‚Ä¶`);
      // Terminate abruptly (no clean close frame = like a network drop)
      ws.close(1006, 'Simulated crash');
      setBtns(false);
    }

    function demoClose() {
      if (!ws) return;
      addLog('sys', `üëã Clean close ‚Äî code 1000. Will NOT trigger auto-reconnect.`);
      ws.close(1000, 'User closed');
    }

    function demoStop() {
      clearTimeout(retryTimer);
      clearInterval(countInterval);
      hideRetry();
      addLog('sys', `üõë Auto-reconnect stopped manually.`);
      setDot('error', 'Stopped');
      document.getElementById('dBtnStop').disabled = true;
      document.getElementById('dBtnConn').disabled = false;
    }
  </script>

</body>

</html>